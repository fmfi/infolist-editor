<div tal:define="
     name name|field.name;
     style field.widget.style;
     oid oid|field.oid;
     css_class css_class|field.widget.css_class;"
     tal:omit-tag="">

  <input type="text" tal:attributes="
          name name;
          id oid;
          class string: ${css_class};
          style style;
          value cstruct;"
           />

  <script type="text/javascript">
    deform.addCallback(
      '${field.oid}',
      function(oid) {
        $('#' + oid).selectize({
          delimiter: " ",
          enableDuplicate: true,
          hideSelected: false,
          options: ${options},
          render: {
            item: function(item, escape) {
              if (item.value == '(' || item.value == ')') {
                return '<div class="zatvorka">' + escape(item.value) + '</div>';
              }
              else if (item.value == 'OR' || item.value == 'AND') {
                return '<div class="spojka">' + escape(item.value == 'AND' ? 'a' : 'alebo') + '</div>';
              }
              var text = item.skratka + " " + item.nazvy.join("|");
              return '<' + 'div>' +
                 escape(text) +
              '<' + '/div>';
            },
            option: function(item, escape) {
              if (item.value == '(' || item.value == ')') {
                return '<div class="zatvorka">' + escape(item.value) + '</div>';
              }
              else if (item.value == 'OR' || item.value == 'AND') {
                return '<div class="spojka">' + escape(item.value == 'AND' ? 'a' : 'alebo') + '</div>';
              }
              var text = item.skratka + " " + item.nazvy.join("|");
              return '<' + 'div>' +
                 escape(text) + 
              '<' + '/div>';
            }
          },
          load: function(query, callback) {
            if (!query.length || query.length < 2) return callback();
            $.ajax({
              url: "${search_url}",
              data: {
                q: query
              },
              error: function() {
                callback();
              },
              success: function(data) {
                callback($.map(data.predmety, function(predmet) {
                  var text = predmet.skratka + " " + predmet.nazvy_predmetu.join("|");
                  return {value: predmet.id, kod: predmet.kod_predmetu, skratka: predmet.skratka, typ: 'predmet', text: text, nazvy: predmet.nazvy_predmetu}
                }));
              }
            });
          },
        });
      }
    );
  </script>

</div>

